#!/usr/bin/env python

import requests
import re
import time
import urllib
from lib.guerrillamail import GuerrillaMailSession

INVITE_TOKEN = "" #5-character reservation ID
EMAIL_CHECK_TIMEOUT = 60 # number of seconds to wait for the email

while(True):
  session = GuerrillaMailSession()
  email_address = session.get_session_state()['email_address']
  req_url = "https://invites.oneplus.net/index.php?r=share/signup&success_jsonpCallback=success_jsonpCallback&email={0}&koid={1}&_={2}".format(urllib.quote_plus(email_address), INVITE_TOKEN, str(int(time.time())*1000))

  print("Sending invite to " + email_address + "...")
  requests.get(req_url)

  print("Checking mailbox for the magic email...")
  email_id = None
  for i in range(0, EMAIL_CHECK_TIMEOUT):
    email_id = session.get_email_list()[0].guid
    time.sleep(1)
    if session.get_email(email_id).subject != "Confirm your email":
      continue

  if email_id == 1:
    print("Couldn't find the magic email on the mailbox after " + str(EMAIL_CHECK_TIMEOUT) + " seconds!.")
    print("Let's try to send more invites...")
    print("")
    continue

  print("Found! Fetching email id " + email_id + " body...")
  email_body = session.get_email(email_id).body

  m = re.search('http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', email_body)
  new_url = m.group(0).rstrip(".")
  print("Clicking confirmation link...")
  requests.get(m.group(0).rstrip("."))
  print("Referral sucessfully spoofed...")
  print("")
